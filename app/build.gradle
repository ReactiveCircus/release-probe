plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'kotlin-android-extensions'
    id 'com.google.gms.google-services'
    id 'com.getkeepsafe.dexcount'
    id 'project-report'
}

apply from: "$project.rootDir/gradle/versioning.gradle"

android {
    compileSdkVersion buildConfig.compileSdk
    buildToolsVersion buildConfig.buildTools

    defaultConfig {
        minSdkVersion buildConfig.minSdk
        targetSdkVersion buildConfig.targetSdk

        applicationId 'ychescale9.releaseprobe'
        versionCode buildVersionCode()
        versionName buildVersionName()
        archivesBaseName = "ReleaseProbe-$versionName"

        testApplicationId 'ychescale9.releaseprobe.test'
        testInstrumentationRunner "ychescale9.releaseprobe.MainTestRunner"

        // only support English for now
        resConfigs "en"

        // app name
        resValue 'string', 'app_name', "ReleaseProbe"
    }

    dexOptions {
        // do not pre-dex on CI
        preDexLibraries !isCiBuild
    }

    packagingOptions {
        exclude 'kotlin/**'
        exclude '**/*.kotlin_metadata'
        exclude 'META-INF/*.kotlin_module'
        exclude 'META-INF/*.version'
        exclude 'META-INF/*.properties'
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    lintOptions {
        disable 'ParcelCreator'
        disable 'GoogleAppIndexingWarning'
        quiet true
        ignoreWarnings true
        htmlReport true
        xmlReport true
        htmlOutput file("$buildDir/reports/lint/lint-reports.html")
        xmlOutput file("$buildDir/reports/lint/lint-reports.xml")
        checkDependencies true
        ignoreTestSources true
        checkReleaseBuilds false
    }

    signingConfigs {
        debug {
            storeFile rootProject.file('secrets/debug.keystore')
            storePassword 'rp-debug'
            keyAlias 'rp-key'
            keyPassword 'rp-debug'
        }
        release {
            storeFile rootProject.file('secrets/release-probe.keystore')
            storePassword envOrProp('RELEASE_PROBE_STORE_PASSWORD')
            keyAlias 'releaseprobe'
            keyPassword envOrProp('RELEASE_PROBE_KEY_PASSWORD')
        }
    }

    bundle {
        // only support English for now
        language.enableSplit = false
    }

    buildTypes {
        debug {
            ext.alwaysUpdateBuildId = false
            testCoverageEnabled true
            signingConfig signingConfigs.debug
        }
        release {
            if (rootProject.file('secrets/release-probe.keystore').exists()) {
                signingConfig signingConfigs.release
            }
            minifyEnabled true
            shrinkResources true
            proguardFiles('shrinker-rules.pro')
        }
    }

    flavorDimensions "environment"

    productFlavors {
        mock {
            applicationIdSuffix ".mock"
            // disable Bugsnag plugin for mock builds
            ext.enableBugsnag = false
            // Bugsnag API key for mock builds
            manifestPlaceholders = [bugsnagApiKey: ""]
            // disable Bugsnag for mock builds
            buildConfigField 'boolean', 'ENABLE_BUGSNAG', 'Boolean.parseBoolean("false")'
            // disable analytics for mock builds
            buildConfigField 'boolean', 'ENABLE_ANALYTICS', 'Boolean.parseBoolean("false")'
        }
        prod {
            manifestPlaceholders = [
                    bugsnagApiKey: "${envOrProp('RELEASE_PROBE_BUGSNAG_API_KEY')}"
            ]

            buildConfigField 'boolean', 'ENABLE_BUGSNAG', 'Boolean.parseBoolean("true")'
            buildConfigField 'boolean', 'ENABLE_ANALYTICS', 'Boolean.parseBoolean("true")'
        }
    }

    // filter out mockRelease and prodDebug (when on CI) builds.
    android.variantFilter { variant ->
        variant.getFlavors().each { flavor ->
            if (flavor.name != 'prod' && variant.buildType.name == 'release' ||
                    isCiBuild && flavor.name == 'prod' && variant.buildType.name == 'debug') {
                variant.setIgnore(true)
            }
        }
    }

    android.applicationVariants.configureEach { variant ->
        // customize app name for debug builds
        if (variant.buildType.name == "debug") {
            // get app_name field from defaultConfig
            def appName = variant.mergedFlavor.resValues.get('app_name').getValue()

            // concatenate productFlavor to app name for non-production builds
            if (variant.flavorName != "prod") {
                appName += "-${variant.flavorName}"
            }

            // concatenate buildType to app name for non-release builds
            appName += "-${variant.buildType.name}"

            // set new app_name
            variant.resValue 'string', 'app_name', appName
        }
    }

    testOptions {
        animationsDisabled = true
    }
}

dependencies {
    implementation project(path: ':bugsnag-tree')
    prodImplementation project(path: ':analytics-api-firebase')
    mockImplementation project(path: ':analytics-api-no-op')

    implementation project(path: ':feature-base')
    implementation project(path: ':feeds')
    implementation project(path: ':watchlist')
    implementation project(path: ':browse-collections')
    implementation project(path: ':settings')

    implementation project(path: ':data')
    prodImplementation project(path: ':remote-api-real')
    mockImplementation project(path: ':remote-api-mock')

    implementation project(path: ':tasks')

    // Bugsnag
    implementation "com.bugsnag:bugsnag-android:${versions.bugsnag}"

    // Koin
    implementation "org.koin:koin-android:${versions.koin}"
    implementation "org.koin:koin-androidx-viewmodel:${versions.koin}"
    implementation "org.koin:koin-core-ext:${versions.koin}"

    // Firebase core
    prodImplementation "com.google.firebase:firebase-core:${versions.firebase.core}"

    // Leak detection
    debugImplementation "com.squareup.leakcanary:leakcanary-android:${versions.leakCanary}"
    debugImplementation "com.squareup.leakcanary:leakcanary-support-fragment:${versions.leakCanary}"
    releaseImplementation "com.squareup.leakcanary:leakcanary-android-no-op:${versions.leakCanary}"

    // Unit tests
    testImplementation "junit:junit:${versions.junit}"
    testImplementation "io.mockk:mockk:${versions.mockk}"

    testImplementation "org.amshove.kluent:kluent:${versions.kluent}"
    testImplementation "androidx.arch.core:core-testing:${versions.androidx.arch.coreTesting}"
    testImplementation "org.koin:koin-test:${versions.koin}"

    // Android tests
    androidTestImplementation project(path: ':testing-infra')
}

// use no-op LeakCanary dependency in tests
configurations.configureEach { configuration ->
    if (configuration.name.contains('UnitTest') || configuration.name.contains('AndroidTest')) {
        configuration.resolutionStrategy.eachDependency { details ->
            if (details.requested.group == 'com.squareup.leakcanary' && details.requested.name == 'leakcanary-android') {
                details.useTarget(group: details.requested.group, name: 'leakcanary-android-no-op', version: details.requested.version)
            }
        }
    }
}

tasks.whenTaskAdded { task ->
    // don't count dex methods for debug builds
    if (task.name.endsWith("DebugDexMethods")) {
        task.configure {
            it.enabled = false
        }
    }
}

android.applicationVariants.configureEach { variant ->
    // disable google services plugin for mock flavor
    tasks.named("process${variant.name.capitalize()}GoogleServices").configure {
        it.enabled = !variant.name.contains("mock")
    }
}
